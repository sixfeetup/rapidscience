{% load bookmarks comments discussion_tags el_pagination_tags core_tags %}

{% lazy_paginate activity_stream %}
{% for action in activity_stream %}
  {% with obj=action.action_object model=action.action_object_content_type.model content_type=action.action_object_content_type.id%}
  <div class="activity-stream activity-{{ model }} verb-{{ action.verb }}">
    {% if obj %}
      <div class="row">
          <div class="col-md-11">
            <p class="small action-detail">
              {% include 'actstream/_action_detail.html' %}
            </p>
            {% if action.description and model != "casereport" and model != "reference" %}
            <blockquote>
              <p>{{ action.description }}</p>
            </blockquote>
            {% endif %}
            {% if model == 'file' %}
              {% include 'documents/_file.html' %}
            {% elif model == 'image' %}
              {% include 'documents/_image.html' %}
            {% elif model == 'link' %}
              {% include 'documents/_link.html' %}
            {% elif model == 'video' %}
              {% include 'documents/_video.html' %}
            {% elif model == 'threadedcomment' %}
              {% include 'comments/_comment.html' %}
            {% elif model == 'referenceshare' %}
              {% if obj.comment %}
              <blockquote>
                <p>{{ obj.comment }}</p>
              </blockquote>
              {% endif %}
              {% include 'bibliography/_ref_activity.html' with ref=obj %}
            {% elif model == 'reference' %}
              {% if action.description %}
              <blockquote>
                <p>{{ action.description }}</p>
              </blockquote>
              {% endif %}
              {% include 'bibliography/_ref_activity.html' with ref=obj %}
            {% elif model == "casereport" %}
                {% if action.description %}
                <blockquote>
                  <p>{{ action.description }}</p>
                </blockquote>
                {% endif %}
              {% include 'casereport/casereport_activity.html' %}
            {% endif %}

                {# tags and workflow status #}
                {% if action.action_object.tags or model == "casereport" %}
                  <p class="tags">
                    {% if model == "casereport" %}
                        {% if request.user.is_superuser or request.user == obj.primary_author %}
                        <span class="btn btn-tag btn-xs cr-workflow">
                            <i class="{{ obj.get_workflow_icon }}" aria-hidden="true"></i>
                            {% if obj.workflow_state == 'live' %}
                                Posted
                            {% elif obj.workflow_state == 'draft' %}
                                Draft
                            {% elif obj.workflow_state == 'author review' %}
                                Author Review
                            {% elif obj.workflow_state == 'processing' %}
                                Submitted
                            {% else %}
                                {{ obj.workflow_state }}
                            {% endif %}
                        </span>
                        {% endif %}
                    {% endif %}
                    {%  if model == 'reference' %}

                        {% for tag in action.action_object.current_user_reference.tags.all %}
                            {% if tag.slug != '' %}
                                <a role="button" class="btn btn-tag btn-xs" href="{% url 'haystack_search' %}?tags={{ tag.id }}">
                                    {{ tag }}
                                </a>
                            {% endif %}
                        {% endfor %}
                    {% else %}

                        {% for tag in action.action_object.tags.all %}
                          {% if tag.slug != '' %}
                          <a role="button" class="btn btn-tag btn-xs" href="{% url 'haystack_search' %}?tags={{ tag.id }}">
                            {{ tag }}
                          </a>
                          {% endif %}
                        {% endfor %}
                    {% endif %}
                  </p>
                {% endif %}
          </div>
          <div class="col-md-1 activity-actions">
            {% if model != 'referenceshare' %}
                {% include 'discussions/discussion_count_widget.html' %}
            {% endif %}
            {% if model == "casereport" and obj.workflow_state != 'live' %}
                <!-- SUPPRESSED SHARE BTN for {{action.verb }} CR -->
            {% else %}
                {% if user != obj.get_poster %}
                    {% if project %}
                        <form class="bookmark-form" method="POST" action="{% toggle_bookmark_url obj project %}">
                    {% else %}
                        <form class="bookmark-form" method="POST" action="{% toggle_bookmark_url obj user %}">
                    {% endif %}
                    {% csrf_token %}
                    <input type="hidden" name="{% if project %}group{% else %}dashboard{% endif %}" value="on" />
                    <input type="hidden" name="content_type" value="{{ content_type }}" />
                    <input type="hidden" name="content_id" value="{{ obj.id }}" />
                    <a href="#" class="bookmark-trigger" data-toggle="tooltip"><i class="fa fa-star" aria-hidden="true"></i></a>
                    </form>
                {% endif %}
            {% endif %}
            {% if model == 'file' or model == 'image' or model == 'link' or model == 'video' or model == 'document' %}
                <a class="share-link" href="/send/documents/document/{{ obj.id }}" title="Share"><i class="fa fa-share"></i></a>
            {% elif model == 'casereport' %}
                <a class="share-link" href="/send/casereport/casereport/{{ obj.id }}" title="Share"><i class="fa fa-share"></i></a>
            {% elif model == 'threadedcomment' %}
              {% if obj.discussion_root.is_discussion %}
                <a class="share-link" href="/send/discussions/threadedcomment/{{ obj.discussion_root.id }}" title="Share"><i class="fa fa-share"></i></a>
              {% endif %}
            {% elif model == 'reference' %}
                <a class="share-link" href="/send/bibliography/reference/{{ obj.id }}" title="Share"><i class="fa fa-share"></i></a>
            {% endif %}


          </div>
      </div>
    {% endif %}
  </div>
  {% endwith %}
  <hr>
{% empty %}
  <p>There is no recent activity</p>
{% endfor %}
{% show_more %}
