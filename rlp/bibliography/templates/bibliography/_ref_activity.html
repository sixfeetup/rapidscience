{% load core_tags %}
{% user_can_link ref.reference as can_link %}
{#  FYI: the ref on this page is a UserReference#}
{% if not search %}<h4>{% endif %}
{% with ref.reference.parsed_data as parsed_data %}
{% if parsed_data.authors %}
  {{ parsed_data.authors }}. {% endif %}
{% if ref.reference.get_source_url %}{% if not search %}
  {% if can_link %}
    <a href="{{ ref.get_absolute_url }}">
  {% endif %}
{% endif %}{% endif %}
{{ parsed_data.title|striptags }}
{% if ref.reference.get_source_url %}{% if not search %}
  {% if can_link %}</a>{% endif %}
{% endif %}{% endif %},
{% if parsed_data.container_title %}in
  <em>{% autoescape off %}
    {{ parsed_data.container_title }}{% endautoescape %}</em>
  ,{% endif %}
{% if parsed_data.page %}pp {{ parsed_data.page }}
  .{% endif %}
{% if parsed_data.publication_date %}
  {{ parsed_data.publication_date }};{% endif %}
{{ parsed_data.publisher }} {{ parsed_data.journal_title }}
{% if parsed_data.doi %}DOI:
  {{ parsed_data.doi }}{% endif %}
{% if parsed_data.pubmed_id %}PMID:
  {{ parsed_data.pubmed_id }}{% endif %}
{% if not search %}</h4>{% endif %}
{% if ref.description %}
  {% if not search %}
    <div class="more">{% endif %}
{% autoescape off %}{{ ref.user_description }}
  {{ ref.description }}{% endautoescape %}
{% if not search %}</div>{% endif %}
{% endif %}
{% if action.verb == 'shared' %}
  {% if not search %}<p class="small meta">{% endif %}
Posted by
<a href="{% url 'profile' ref.user_id %}">{% if request.user == ref.user %}
  me {% else %} {{ ref.user }} {% endif %}</a>
| {{ ref.date_updated|date:"j M Y" }}{% if not search %}<br/>{% endif %}
{% if ref %}
  {% display_shared_with ref request.user %}
{% else %}
  {% display_shared_with obj request.user %}
{% endif %}
{% if not search %}</p>{% endif %}
{% endif %}
{% endwith %}
